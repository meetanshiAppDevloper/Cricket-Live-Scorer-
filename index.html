<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>CrickMatch Live Scorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      color: #111827;
    }
    /* Hide scrollbar for modal content but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .tab-active {
      border-bottom: 3px solid #4A3A8C;
      color: #4A3A8C;
      font-weight: 700;
    }
    .tab-inactive {
      border-bottom: 3px solid transparent;
      color: #6B7280;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- âœ… Match ID Not Found Screen -->
  <div id="no-match-id-screen" class="hidden flex-grow flex flex-col items-center justify-center p-6 text-center h-screen">
    <div class="bg-red-100 p-5 rounded-full mb-6">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    </div>
    <h1 class="text-2xl font-bold text-gray-900 mb-2">Match ID Not Found</h1>
    <p class="text-gray-600 max-w-xs mx-auto">It seems the link is broken or the Match ID is missing. Please check the URL and try again.</p>
  </div>

  <!-- âœ… Main Content Wrapper -->
  <div id="main-content" class="w-full pb-20">
    <div class="w-full bg-[#4A3A8C] text-white text-center p-3 text-xl font-bold shadow-lg">
      CrickMatch Live Scorer App
    </div>

    <div class="max-w-md mx-auto p-4">
      <header class="text-center mb-4">
        <div class="flex justify-center items-center gap-3 mb-1">
          <h1 class="text-xl font-bold">Live Cricket Score</h1>
        </div>
        <p id="match-title" class="text-gray-600 font-medium">-- vs --</p>
      </header>

      <div id="scoreboard" class="bg-white rounded-xl shadow-lg p-5 space-y-4 hidden">
        <!-- Main Header -->
        <div class="flex justify-between items-start">
          <div>
            <h2 id="battingTeamName" class="text-2xl font-bold">--</h2>
            <div class="flex items-center gap-3 mt-1">
              <div id="innings-info" class="text-sm text-gray-500 font-medium">-- Innings</div>
            </div>
            <div class="mt-2 flex flex-col gap-1">
              <span class="text-sm text-[#4A3A8C] font-medium">CRR : <span id="crr" class="font-bold">0.00</span></span>
              <span id="rrr-container" class="hidden text-sm text-[#4A3A8C] font-medium">RRR : <span id="rrr" class="font-bold">0.00</span></span>
            </div>
          </div>

          <div class="flex justify-center items-start pt-1">
            <span id="status-badge" class="text-white text-xs font-bold px-1.5 py-0 rounded-full flex items-center gap-0.5">
              <span id="status-ping" class="relative flex h-1.5 w-1.5">
                <span id="status-ping-animate" class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                <span id="status-ping-dot" class="relative inline-flex rounded-full h-1.5 w-1.5"></span>
              </span>
              <span id="status-text">--</span>
            </span>
          </div>

          <div class="text-right flex flex-col items-end gap-1">
            <div id="score" class="text-4xl font-extrabold text-gray-900">0/0</div>
            <div id="overs" class="text-sm text-gray-500 font-medium">(0.0 Overs)</div>
            <p id="target-display" class="text-md font-semibold text-gray-800 mt-1"></p>
          </div>
        </div>

        <div id="target-needed-info" class="hidden text-center border-t border-gray-200 pt-3">
          <p id="target-needed" class="text-sm font-semibold text-gray-800"></p>
          <p id="mom-display" class="text-sm font-bold text-[#4A3A8C] mt-2 hidden"></p>
        </div>

        <!-- Current Batsmen -->
        <div class="border-t border-gray-200 pt-3 space-y-2">
          <div class="flex justify-between text-lg">
            <span id="strikerName" class="font-semibold">Batsman 1 *</span>
            <span id="strikerScore" class="font-mono">0 (0)</span>
          </div>
          <div class="flex justify-between text-lg">
            <span id="nonStrikerName" class="font-semibold text-gray-600">Batsman 2</span>
            <span id="nonStrikerScore" class="font-mono text-gray-600">0 (0)</span>
          </div>
        </div>

        <!-- Current Bowler -->
        <div class="border-t border-gray-200 pt-3">
          <div class="flex justify-between text-lg">
            <span id="bowlerName" class="font-semibold">--</span>
            <span id="bowlerFigures" class="font-mono">0-0 (0.0)</span>
          </div>
        </div>

        <!-- This Over -->
        <div class="border-t border-gray-200 pt-3">
          <h3 class="text-sm font-semibold text-gray-500 mb-2 text-left">This Over:</h3>
          <div id="thisOverContainer" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
      
      <!-- âœ… NEW BUTTON: View Full Scorecard -->
      <button id="view-scorecard-btn" class="hidden w-full mt-4 bg-white border-2 border-[#4A3A8C] text-[#4A3A8C] font-bold py-3 rounded-lg hover:bg-gray-50 shadow-sm transition">
        View Full Scorecard
      </button>

      <div id="loading" class="text-center py-10">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#4A3A8C] mx-auto"></div>
        <p class="mt-3 text-gray-600">Loading live score...</p>
      </div>

      <div id="error" class="hidden text-center py-8 bg-red-100 border-red-400 text-red-700 rounded-lg"></div>

      <button id="open-app-btn" class="hidden w-full mt-6 bg-[#4A3A8C] hover:bg-[#3b2e70] text-white font-bold py-3 rounded-lg transition">
        Open in CrickMatch App
      </button>
    </div>
  </div>

  <!-- âœ… FULL SCORECARD MODAL -->
  <div id="scorecard-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-end sm:items-center">
    <div class="bg-gray-50 w-full sm:w-[95%] sm:max-w-md h-[90vh] sm:h-[85vh] sm:rounded-xl rounded-t-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up">
      
      <!-- Modal Header -->
      <div class="bg-[#4A3A8C] text-white p-4 flex justify-between items-center shrink-0">
        <h2 class="text-lg font-bold">Full Scorecard</h2>
        <button id="close-modal-btn" class="p-1 rounded-full hover:bg-white/20 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Tabs -->
      <div class="bg-white flex border-b border-gray-200 shrink-0">
        <button id="tab-btn-1" class="flex-1 py-3 text-sm text-center tab-active transition" onclick="switchTab(1)">
          1st Innings
        </button>
        <button id="tab-btn-2" class="flex-1 py-3 text-sm text-center tab-inactive transition" onclick="switchTab(2)">
          2nd Innings
        </button>
      </div>

      <!-- Modal Body (Scrollable) -->
      <div class="flex-grow overflow-y-auto p-3 no-scrollbar space-y-6">
        
        <!-- Innings 1 Content -->
        <div id="innings-content-1" class="block">
           <div id="sc-header-1" class="flex justify-between items-center mb-2 px-1">
             <span class="font-bold text-gray-800 text-lg" id="team-name-1">--</span>
             <span class="font-bold text-[#4A3A8C] text-lg" id="team-score-1">0/0 (0.0)</span>
           </div>
           
           <!-- Batting Table 1 -->
           <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4 border border-gray-200">
             <table class="w-full text-sm text-left">
               <thead class="bg-gray-100 text-gray-600 font-medium border-b border-gray-200">
                 <tr>
                   <th class="py-2 px-3">Batter</th>
                   <th class="py-2 px-1 text-right">R</th>
                   <th class="py-2 px-1 text-right">B</th>
                   <th class="py-2 px-1 text-right">4s</th>
                   <th class="py-2 px-1 text-right">6s</th>
                   <th class="py-2 px-2 text-right">SR</th>
                 </tr>
               </thead>
               <tbody id="batting-body-1" class="divide-y divide-gray-100"></tbody>
             </table>
             <div class="p-2 flex justify-between text-sm bg-gray-50 border-t border-gray-100">
                <span class="font-semibold">Extras</span>
                <span id="extras-1">0</span>
             </div>
           </div>

           <!-- Bowling Table 1 -->
           <h3 class="text-sm font-bold text-gray-500 mb-2 px-1">Bowling</h3>
           <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
             <table class="w-full text-sm text-left">
               <thead class="bg-gray-100 text-gray-600 font-medium border-b border-gray-200">
                 <tr>
                   <th class="py-2 px-3">Bowler</th>
                   <th class="py-2 px-1 text-right">O</th>
                   <th class="py-2 px-1 text-right">M</th>
                   <th class="py-2 px-1 text-right">R</th>
                   <th class="py-2 px-1 text-right">W</th>
                   <th class="py-2 px-2 text-right">ER</th>
                 </tr>
               </thead>
               <tbody id="bowling-body-1" class="divide-y divide-gray-100"></tbody>
             </table>
           </div>
        </div>

        <!-- Innings 2 Content -->
        <div id="innings-content-2" class="hidden">
            <div id="msg-innings-2" class="text-center py-10 text-gray-500 hidden">Innings not started yet</div>
            
            <div id="data-innings-2">
                <div id="sc-header-2" class="flex justify-between items-center mb-2 px-1">
                    <span class="font-bold text-gray-800 text-lg" id="team-name-2">--</span>
                    <span class="font-bold text-[#4A3A8C] text-lg" id="team-score-2">0/0 (0.0)</span>
                </div>
                
                <!-- Batting Table 2 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4 border border-gray-200">
                    <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600 font-medium border-b border-gray-200">
                        <tr>
                        <th class="py-2 px-3">Batter</th>
                        <th class="py-2 px-1 text-right">R</th>
                        <th class="py-2 px-1 text-right">B</th>
                        <th class="py-2 px-1 text-right">4s</th>
                        <th class="py-2 px-1 text-right">6s</th>
                        <th class="py-2 px-2 text-right">SR</th>
                        </tr>
                    </thead>
                    <tbody id="batting-body-2" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div class="p-2 flex justify-between text-sm bg-gray-50 border-t border-gray-100">
                        <span class="font-semibold">Extras</span>
                        <span id="extras-2">0</span>
                    </div>
                </div>

                <!-- Bowling Table 2 -->
                <h3 class="text-sm font-bold text-gray-500 mb-2 px-1">Bowling</h3>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
                    <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600 font-medium border-b border-gray-200">
                        <tr>
                        <th class="py-2 px-3">Bowler</th>
                        <th class="py-2 px-1 text-right">O</th>
                        <th class="py-2 px-1 text-right">M</th>
                        <th class="py-2 px-1 text-right">R</th>
                        <th class="py-2 px-1 text-right">W</th>
                        <th class="py-2 px-2 text-right">ER</th>
                        </tr>
                    </thead>
                    <tbody id="bowling-body-2" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables to hold state
    let globalMatchData = null;
    let globalInnings1Data = null;
    let globalInnings2Data = null;

    // --- Tab Switching Logic (Global Scope) ---
    window.switchTab = function(tabId) {
      // Buttons
      const btn1 = document.getElementById('tab-btn-1');
      const btn2 = document.getElementById('tab-btn-2');
      // Content
      const content1 = document.getElementById('innings-content-1');
      const content2 = document.getElementById('innings-content-2');

      if(tabId === 1) {
        btn1.className = 'flex-1 py-3 text-sm text-center tab-active transition';
        btn2.className = 'flex-1 py-3 text-sm text-center tab-inactive transition';
        content1.classList.remove('hidden');
        content2.classList.add('hidden');
      } else {
        btn1.className = 'flex-1 py-3 text-sm text-center tab-inactive transition';
        btn2.className = 'flex-1 py-3 text-sm text-center tab-active transition';
        content1.classList.add('hidden');
        content2.classList.remove('hidden');
      }
    };

    // --- Modal Logic ---
    const modal = document.getElementById('scorecard-modal');
    const openBtn = document.getElementById('view-scorecard-btn');
    const closeBtn = document.getElementById('close-modal-btn');

    openBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent body scroll
    });

    closeBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; 
    });

    (function () {
      const firebaseConfig = {
        apiKey: atob("QUl6YVN5RDNTUEZhNmI0dmc1bHdISzlobTd0SnV5aS05eFRyb0dJ"),
        authDomain: "cricket-scorer-app-a9d37.firebaseapp.com",
        projectId: "cricket-scorer-app-a9d37",
        storageBucket: "cricket-scorer-app-a9d37.appspot.com",
        messagingSenderId: "533428996475",
        appId: "1:533428996475:web:58161d5066d65ad2dd15de",
        measurementId: "G-DQP2DZY5E5"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      function showMatchNotFoundScreen() {
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('no-match-id-screen').classList.remove('hidden');
        document.getElementById('loading').style.display = 'none';
      }

      const urlParams = new URLSearchParams(window.location.search);
      let matchId = urlParams.get('matchId');

      if (!matchId) {
        showMatchNotFoundScreen();
        return;
      }

      const openAppBtn = document.getElementById('open-app-btn');
      openAppBtn.style.display = 'block';

      // --- Deep Link Logic (Unchanged) ---
      const originalButtonText = 'Open in CrickMatch App';
      function resetButtonState() {
          openAppBtn.disabled = false;
          openAppBtn.innerHTML = originalButtonText;
      }
      document.addEventListener('visibilitychange', () => {
          if (!document.hidden) resetButtonState();
      });
      openAppBtn.addEventListener('click', () => {
        openAppBtn.disabled = true;
        openAppBtn.innerHTML = `
            <div class="flex items-center justify-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Opening app...
            </div>
        `;
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        if (/android/i.test(userAgent)) {
            const intentUrl = `intent://match?id=${matchId}#Intent;scheme=cricketscorer;package=com.meetanshi.crickmatch;S.browser_fallback_url=https://play.google.com/store/apps/details?id=com.meetanshi.crickmatch;end`;
            window.location.href = intentUrl;
            setTimeout(resetButtonState, 2000);
        } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            window.location.href = `cricketscorer://match?id=${matchId}`;
            setTimeout(() => { if (!document.hidden) window.location.href = 'https://apps.apple.com/us/app/crickmatch-live-scorer/id6755029198'; resetButtonState(); }, 2500);
        } else {
            alert("Please open this link on a mobile device.");
            resetButtonState();
        }
      });

      // --- Firebase Listeners ---
      
      const matchRef = doc(db, 'matches', matchId);
      
      // 1. Listen to Match Data
      onSnapshot(matchRef, (matchDoc) => {
        if (matchDoc.exists()) {
          globalMatchData = matchDoc.data();
          refreshAllViews();
        } else {
          showMatchNotFoundScreen();
        }
      }, (error) => {
        console.error("Firebase match error:", error);
        showError("Unable to connect to Firebase.");
      });

      // 2. Listen to Innings 1 Data
      onSnapshot(doc(db, 'matches', matchId, 'innings', '1'), (docSnapshot) => {
        if (docSnapshot.exists()) {
            globalInnings1Data = docSnapshot.data();
            refreshAllViews();
        }
      });

      // 3. Listen to Innings 2 Data
      onSnapshot(doc(db, 'matches', matchId, 'innings', '2'), (docSnapshot) => {
        if (docSnapshot.exists()) {
            globalInnings2Data = docSnapshot.data();
            refreshAllViews();
        } else {
            globalInnings2Data = null; // Reset if not started
            refreshAllViews();
        }
      });

    })();

    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      const errDiv = document.getElementById('error');
      errDiv.innerText = msg;
      errDiv.classList.remove('hidden');
    }

    // Master function to update all UI
    function refreshAllViews() {
        if(!globalMatchData) return;

        // Determine which innings to show on the main card
        const currentInningsNum = globalMatchData.currentInnings || 1;
        let activeInningsData = (currentInningsNum === 2) ? globalInnings2Data : globalInnings1Data;

        // If Innings 1 is done but Innings 2 doc hasn't arrived yet, we might want to stick to Innings 1 or show loading
        // But usually activeInningsData will be defined. 
        
        if (activeInningsData) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').classList.add('hidden');
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('view-scorecard-btn').classList.remove('hidden'); // Show the button
            updateScoreboard(globalMatchData, activeInningsData);
        }

        // Update Full Scorecard Modal whenever data changes
        updateFullScorecard();
    }

    // Function to render the Full Scorecard Tables
    function updateFullScorecard() {
        if (!globalMatchData) return;

        const { hostTeamName, visitorTeamName, tossWinner, optedTo } = globalMatchData.matchSetup;
        
        // Determine Team Names Logic
        // Innings 1 Team: Toss Winner if Bat, or Toss Loser if Bat
        let team1Name, team2Name;
        
        // Logic: if (TossWinner == Host && Opt == Bat) -> Host is Team 1
        // if (TossWinner == Host && Opt == Bowl) -> Visitor is Team 1
        if ((tossWinner === hostTeamName && optedTo === 'bat') || (tossWinner === visitorTeamName && optedTo === 'bowl')) {
            team1Name = hostTeamName;
            team2Name = visitorTeamName;
        } else {
            team1Name = visitorTeamName;
            team2Name = hostTeamName;
        }

        // Render Innings 1
        if (globalInnings1Data) {
            document.getElementById('team-name-1').innerText = team1Name;
            
            const o = Math.floor(globalInnings1Data.ballsBowled / 6);
            const b = globalInnings1Data.ballsBowled % 6;
            document.getElementById('team-score-1').innerText = `${globalInnings1Data.totalRuns}/${globalInnings1Data.wickets} (${o}.${b})`;
            
            renderBattingTable(globalInnings1Data.battingCard, 'batting-body-1');
            renderBowlingTable(globalInnings1Data.bowlingCard, 'bowling-body-1');
            document.getElementById('extras-1').innerText = calculateExtras(globalInnings1Data);
        }

        // Render Innings 2
        if (globalInnings2Data) {
            document.getElementById('msg-innings-2').classList.add('hidden');
            document.getElementById('data-innings-2').classList.remove('hidden');
            document.getElementById('team-name-2').innerText = team2Name;

            const o = Math.floor(globalInnings2Data.ballsBowled / 6);
            const b = globalInnings2Data.ballsBowled % 6;
            document.getElementById('team-score-2').innerText = `${globalInnings2Data.totalRuns}/${globalInnings2Data.wickets} (${o}.${b})`;

            renderBattingTable(globalInnings2Data.battingCard, 'batting-body-2');
            renderBowlingTable(globalInnings2Data.bowlingCard, 'bowling-body-2');
            document.getElementById('extras-2').innerText = calculateExtras(globalInnings2Data);
        } else {
            document.getElementById('msg-innings-2').classList.remove('hidden');
            document.getElementById('data-innings-2').classList.add('hidden');
        }
    }

   function calculateExtras(data) {
        if (!data || !data.extras) return "0";

        const ex = data.extras;
        const wd = ex.wides || 0;
        const nb = ex.noBalls || 0;
        const b = ex.byes || 0;
        const lb = ex.legByes || 0;
        const total = wd + nb + b + lb;

        return `${total} (wd ${wd}, nb ${nb}, b ${b}, lb ${lb})`;
    }

function renderBattingTable(card, elementId) {
        const tbody = document.getElementById(elementId);
        tbody.innerHTML = '';
        if (!card) return;

        // àª¡à«‡àªŸàª¾ àª¨àª•à«àª•à«€ àª•àª°à«‹ (Innings 1 or 2)
        let specificInningsData = null;
        if (elementId.includes('1')) {
            specificInningsData = globalInnings1Data;
        } else {
            specificInningsData = globalInnings2Data;
        }

        const strikerIndex = specificInningsData?.strikerIndex;
        const nonStrikerIndex = specificInningsData?.nonStrikerIndex;

        card.forEach((p, idx) => {
            const isStriker = (idx === strikerIndex);
            const isNonStriker = (idx === nonStrikerIndex);
            
            // àªœà«‹ àªªà«àª²à«‡àª¯àª° àª°àª®à«àª¯à«‹ àª¹à«‹àª¯ àª…àª¥àªµàª¾ àª¹àª¾àª² àª°àª®àª¤à«‹ àª¹à«‹àª¯ àª¤à«‹ àªœ àª¬àª¤àª¾àªµà«‹
            const shouldShow = (p.balls > 0 || p.runs > 0 || p.isOut || isStriker || isNonStriker);

            if (shouldShow) {
                const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(1) : '0.0';
                
                let playerNameHtml = p.name;
                let statusStyle = 'text-gray-800 font-medium';
                let dismissalInfo = '';

                if (p.isOut) {
                    // --- àªœà«‹ àª†àª‰àªŸ àª¹à«‹àª¯ ---
                    statusStyle = 'text-red-600 font-medium'; 
                    let dismissalText = 'out';
                    
                    if (p.dismissalType) {
                         if (p.dismissalType === 'bowled') dismissalText = `b ${p.bowlerName || ''}`;
                         else if (p.dismissalType === 'caught') dismissalText = `c ${p.fielderName || ''} b ${p.bowlerName || ''}`;
                         else if (p.dismissalType === 'lbw') dismissalText = `lbw b ${p.bowlerName || ''}`;
                         else if (p.dismissalType === 'runOut') dismissalText = `run out (${p.fielderName || ''})`;
                         else if (p.dismissalType === 'stumped') dismissalText = `st ${p.fielderName || ''} b ${p.bowlerName || ''}`;
                         else dismissalText = p.dismissalText || p.dismissalType;
                    }
                    dismissalInfo = `<div class="text-xs text-gray-500 mt-0.5 italic">${dismissalText}</div>`;

                } else if (p.isRetired) {
                    // --- àªœà«‹ àª°àª¿àªŸàª¾àª¯àª°à«àª¡ àª¹à«‹àª¯ ---
                    statusStyle = 'text-gray-500';
                    dismissalInfo = `<div class="text-xs text-gray-500 mt-0.5 italic">retired hurt</div>`;

                } else {
                    // --- àªœà«‹ àª¨à«‹àªŸ àª†àª‰àªŸ àª¹à«‹àª¯ ---
                    statusStyle = 'text-[#4A3A8C] font-bold'; 
                    
                    // âœ…âœ…âœ… àª«à«‡àª°àª«àª¾àª°: àª«àª•à«àª¤ àª¸à«àªŸà«àª°àª¾àªˆàª•àª°àª¨à«‡ àªœ àª¸à«àªŸàª¾àª° (*) àª†àªªàªµà«‹
                    if (isStriker) {
                        playerNameHtml = `${p.name} *`;
                    } else {
                        playerNameHtml = p.name; // Non-striker àª¨à«‡ àª¸à«àªŸàª¾àª° àª¨àª¹àª¿
                    }
                    
                    dismissalInfo = `<div class="text-xs text-[#4A3A8C] mt-0.5 font-medium">not out</div>`;
                }

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="py-2 px-3">
                        <div class="${statusStyle}">${playerNameHtml}</div>
                        ${dismissalInfo}
                    </td>
                    <td class="py-2 px-1 text-right font-medium">${p.runs}</td>
                    <td class="py-2 px-1 text-right text-gray-500">${p.balls}</td>
                    <td class="py-2 px-1 text-right text-gray-500">${p.fours || 0}</td>
                    <td class="py-2 px-1 text-right text-gray-500">${p.sixes || 0}</td>
                    <td class="py-2 px-2 text-right text-gray-500">${sr}</td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function renderBowlingTable(card, elementId) {
const tbody = document.getElementById(elementId);
tbody.innerHTML = '';
if (!card) return;
card.forEach(b => {
        if(b.ballsBowled > 0 || b.overs > 0) {
            const overs = Math.floor(b.ballsBowled / 6);
            const balls = b.ballsBowled % 6;
            const totalOversDec = b.ballsBowled / 6;
            const er = totalOversDec > 0 ? (b.runsConceded / totalOversDec).toFixed(1) : '0.0';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="py-2 px-3 font-medium text-gray-800">${b.name}</td>
                <td class="py-2 px-1 text-right text-gray-600">${overs}.${balls}</td>
                <td class="py-2 px-1 text-right text-gray-500">${b.maidens || 0}</td>
                <td class="py-2 px-1 text-right text-gray-500">${b.runsConceded}</td>
                <td class="py-2 px-1 text-right font-bold text-[#4A3A8C]">${b.wickets}</td>
                <td class="py-2 px-2 text-right text-gray-500">${er}</td>
            `;
            tbody.appendChild(tr);
        }
    });
}
 
    // --- Original Logic for Summary Card (Unchanged mostly) ---
     function updateScoreboard(matchData, inningsData) {
      const { hostTeamName, visitorTeamName, tossWinner, optedTo } = matchData.matchSetup;
      document.getElementById('match-title').innerText = `${hostTeamName} vs ${visitorTeamName}`;

      const statusBadge = document.getElementById('status-badge');
      const statusText = document.getElementById('status-text');
      const statusPing = document.getElementById('status-ping-animate');
      const statusDot = document.getElementById('status-ping-dot');

      if (matchData.matchStatus === 'Completed') {
        statusText.innerText = 'COMPLETED';
        statusBadge.className = 'text-white text-xs font-bold px-1.5 py-0 rounded-full flex items-center gap-0.5 bg-blue-500';
        statusPing.className = 'hidden';
        statusDot.className = 'hidden';
      } else if (matchData.matchStatus === 'Live') {
        statusText.innerText = 'LIVE';
        statusBadge.className = 'text-white text-xs font-bold px-1.5 py-0 rounded-full flex items-center gap-0.5 bg-red-500';
        statusPing.className = 'animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75';
        statusDot.className = 'relative inline-flex rounded-full h-1.5 w-1.5 bg-white';
      } else {
        statusText.innerText = 'PAUSED';
        statusBadge.className = 'text-white text-xs font-bold px-1.5 py-0 rounded-full flex items-center gap-0.5 bg-gray-500';
        statusPing.className = 'hidden';
        statusDot.className = 'relative inline-flex rounded-full h-1.5 w-1.5 bg-gray-400';
      }

      const currentInnings = matchData.currentInnings || 1;
      document.getElementById('innings-info').innerText = currentInnings === 1 ? '1st Innings' : '2nd Innings';

      const isSecondInnings = currentInnings === 2;
      let battingTeam = ((tossWinner === hostTeamName && optedTo === 'bat') || (tossWinner === visitorTeamName && optedTo === 'bowl')) ? (isSecondInnings ? visitorTeamName : hostTeamName) : (isSecondInnings ? hostTeamName : visitorTeamName);
      document.getElementById('battingTeamName').innerText = battingTeam;

      const { totalRuns, wickets, ballsBowled, battingCard, bowlingCard, strikerIndex, nonStrikerIndex, currentBowlerIndex, thisOverEvents } = inningsData;
      document.getElementById('score').innerText = `${totalRuns}/${wickets}`;

      const overs = Math.floor(ballsBowled / 6);
      const balls = ballsBowled % 6;
      document.getElementById('overs').innerText = `(${overs}.${balls} Overs)`;

      const crr = (ballsBowled > 0) ? (totalRuns / (ballsBowled / 6)).toFixed(2) : '0.00';
      document.getElementById('crr').innerText = crr;

       const rrrContainer = document.getElementById('rrr-container');
      const rrrText = document.getElementById('rrr');

      if (isSecondInnings && matchData.target && matchData.matchStatus === 'Live') {
        const target = matchData.target;
        const runsNeeded = target - totalRuns;
        const totalOvers = matchData.matchSetup.totalOvers || 0;
        const totalBalls = totalOvers * 6;
        const ballsRemaining = totalBalls - ballsBowled;

        if (ballsRemaining > 0 && runsNeeded > 0) {
          const rrr = (runsNeeded * 6) / ballsRemaining;
          rrrText.innerText = rrr.toFixed(2);
          rrrContainer.classList.remove('hidden');
        } else {
          rrrContainer.classList.add('hidden');
        }
      } else {
        rrrContainer.classList.add('hidden');
      }

      const targetDisplayP = document.getElementById('target-display');
      const targetNeededInfoDiv = document.getElementById('target-needed-info');
      const targetNeededP = document.getElementById('target-needed');
      const momDisplayP = document.getElementById('mom-display'); 

      if (matchData.matchStatus === 'Completed' && matchData.resultSummary) {
        targetDisplayP.innerHTML = '';
        targetNeededP.innerHTML = `<span class="text-green-600 font-bold">${matchData.resultSummary}</span>`;
        targetNeededInfoDiv.classList.remove('hidden');

        if (matchData.manOfTheMatch) {
            momDisplayP.innerHTML = `ğŸ† Player of the Match: ${matchData.manOfTheMatch}`;
            momDisplayP.classList.remove('hidden');
        } else {
            momDisplayP.classList.add('hidden');
        }
      } else if (isSecondInnings && matchData.target) {
        momDisplayP.classList.add('hidden');

        const target = matchData.target;
        const runsNeeded = Math.max(0, target - totalRuns);
        const totalBallsInMatch = (matchData.matchSetup.totalOvers || 0) * 6;
        const ballsRemaining = totalBallsInMatch - ballsBowled;
        const playersPerTeam = matchData.matchSetup.playersPerTeam || 11;

        if (runsNeeded === 0 && (ballsRemaining >= 0 || wickets < playersPerTeam - 1)) {
          targetDisplayP.innerHTML = '';
          targetNeededP.innerHTML = `<span class="text-green-600">${battingTeam} won!</span>`;
        } else if (ballsRemaining <= 0 || wickets >= playersPerTeam - 1) {
            if (runsNeeded > 1) {
                targetDisplayP.innerHTML = `<span class="text-red-600">Target: ${target}</span>`;
                targetNeededP.innerHTML = `<span class="text-red-600">${(battingTeam === hostTeamName ? visitorTeamName : hostTeamName)} won by ${runsNeeded - 1} runs!</span>`;
            } else if (runsNeeded === 1) {
                targetDisplayP.innerHTML = `Target: ${target}`;
                targetNeededP.innerHTML = `Match Tied`;
            } else {
                targetDisplayP.innerHTML = '';
                targetNeededP.innerHTML = `<span class="text-green-600">${battingTeam} won!</span>`;
            }
        } else {
          targetDisplayP.innerHTML = `Target: ${target}`;
          targetNeededP.innerHTML = `<span class="text-[#4A3A8C]">Need ${runsNeeded} runs in ${ballsRemaining} balls</span>`;
        }
        targetNeededInfoDiv.classList.remove('hidden');
      } else {
        targetDisplayP.innerHTML = '';
        targetNeededInfoDiv.classList.add('hidden');
        momDisplayP.classList.add('hidden');
      }

      const striker = battingCard?.[strikerIndex] || { name: "Batsman", runs: 0, balls: 0 };
      const nonStriker = battingCard?.[nonStrikerIndex] || { name: "Batsman", runs: 0, balls: 0 };
      document.getElementById('strikerName').innerText = `${striker.name} *`;
      document.getElementById('strikerScore').innerText = `${striker.runs} (${striker.balls})`;
      document.getElementById('nonStrikerName').innerText = nonStriker.name;
      document.getElementById('nonStrikerScore').innerText = `${nonStriker.runs} (${nonStriker.balls})`;

      const bowler = bowlingCard?.[currentBowlerIndex] || { name: "Bowler", wickets: 0, runsConceded: 0, ballsBowled: 0 };
      const o = Math.floor(bowler.ballsBowled / 6);
      const b = bowler.ballsBowled % 6;
      document.getElementById('bowlerName').innerText = bowler.name;
      document.getElementById('bowlerFigures').innerText = `${bowler.wickets}-${bowler.runsConceded} (${o}.${b})`;

      const overContainer = document.getElementById('thisOverContainer');
      overContainer.innerHTML = '';
      (thisOverEvents || []).forEach(event => {
        const ballEl = document.createElement('div');
        const text = event.display.toUpperCase();
        let cls = 'w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm ';
        if (event.type === 'four' || event.type === 'six' || event.type === 'wicket') { cls += 'bg-[#4A3A8C] text-white'; }
        else if (['wide', 'noBall', 'legBye', 'bye'].includes(event.type)) { cls += 'bg-yellow-400 text-yellow-900 text-xs'; }
        else { cls += 'bg-gray-200 text-gray-800'; }
        ballEl.className = cls;
        ballEl.innerText = event.type === 'wicket' ? 'W' : text;
        overContainer.appendChild(ballEl);
      });
    }
  </script>
</body>
</html>
