<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <title>Live Cricket Score</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f0f2f5; 
            color: #333; 
        }
        h2 { 
            color: #007bff; 
        }
        .scoreboard { 
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 12px; 
            max-width: 450px; 
            margin: 20px auto; 
            background-color: #fff; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .team { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .score { 
            font-size: 28px; 
            color: #1a1a1a; 
        }
        .overs { 
            font-size: 16px; 
            color: #555; 
            margin-bottom: 15px; 
        }
        .batsman { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 12px; 
            font-size: 16px; 
        }
        .bowler { 
            text-align: left; 
            margin-top: 15px; 
            font-size: 16px;
        }
        #loading { 
            font-size: 18px; 
            color: #007bff; 
        }
        #error { 
            display: none; 
            color: red; 
            font-weight: bold; 
        }
        hr { 
            border: 0; 
            border-top: 1px solid #eee; 
            margin: 15px 0; 
        }
    </style>
</head>
<body>
    
    <h2>Live Match Score</h2>

    <div id="scoreboard" class="scoreboard" style="display: none;">
        <div class="team">
            <span id="battingTeamName">--</span>
            <span id="score" class="score">0/0</span>
        </div>
        <div id="overs" class="overs">(0.0 Overs)</div>
        <hr>
        <div class="batsman">
            <span><b id="strikerName">Batsman 1</b>*</span>
            <span id="strikerScore">0 (0)</span>
        </div>
        <div class="batsman">
            <span><b id="nonStrikerName">Batsman 2</b></span>
            <span id="nonStrikerScore">0 (0)</span>
        </div>
        <hr>
        <div class="bowler">
             <span><b>Bowler:</b> <span id="bowlerName">--</span></span>
        </div>
    </div>
    
    <div id="loading">Loading live score...</div>
    <div id="error"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- 1. તમારી ફાયરબેઝ કન્ફિગરેશન અહીં ઉમેરેલી છે ---
        const firebaseConfig = {
            apiKey: "AIzaSyD3SPFa6b4vg5lwHK9hm7tJuyi-9xTroGI",
            authDomain: "cricket-scorer-app-a9d37.firebaseapp.com",
            projectId: "cricket-scorer-app-a9d37",
            storageBucket: "cricket-scorer-app-a9d37.appspot.com",
            messagingSenderId: "533428996475",
            appId: "1:533428996475:web:58161d5066d65ad2dd15de",
            measurementId: "G-DQP2DZY5E5"
        };

        // ફાયરબેઝ શરૂ કરો
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. URL માંથી મેચ ID મેળવો ---
        const urlParams = new URLSearchParams(window.location.search);
        const matchId = urlParams.get('matchId');

        if (!matchId) {
            showError('Error: Match ID not found in the link.');
        } else {
            const matchRef = db.collection('matches').doc(matchId);
            
            // onSnapshot લાઇવ અપડેટ માટે ફાયરબેઝ સાથે કનેક્શન બનાવે છે
            matchRef.onSnapshot((matchDoc) => {
                if (matchDoc.exists) {
                    const matchData = matchDoc.data();
                    const currentInnings = matchData.currentInnings || 1;
                    
                    const inningsRef = matchRef.collection('innings').doc(String(currentInnings));
                    
                    inningsRef.onSnapshot((inningsDoc) => {
                        if (inningsDoc.exists) {
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('scoreboard').style.display = 'block';
                            
                            const inningsData = inningsDoc.data();
                            updateScoreboard(matchData, inningsData);
                        } else {
                             showError(`Innings ${currentInnings} data not found for this match.`);
                        }
                    }, (error) => {
                        console.error("Error fetching innings data: ", error);
                        showError('Error loading live score. Check console for details.');
                    });
                } else {
                    showError('Match with the given ID was not found.');
                }
            }, (error) => {
                 console.error("Error fetching match data: ", error);
                 showError('Could not connect to Firebase. Check your security rules and configuration.');
            });
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.innerText = message;
            errorDiv.style.display = 'block';
        }

        // --- 3. આ ફંક્શન સ્કોરબોર્ડ પર ડેટા બતાવે છે ---
        function updateScoreboard(matchData, inningsData) {
            const isSecondInnings = (matchData.currentInnings || 1) === 2;
            const tossWinner = matchData.matchSetup.tossWinner;
            const optedTo = matchData.matchSetup.optedTo;
            const hostTeam = matchData.matchSetup.hostTeamName;
            const visitorTeam = matchData.matchSetup.visitorTeamName;
            
            let battingTeam;
            if ((tossWinner === hostTeam && optedTo === 'bat') || (tossWinner === visitorTeam && optedTo === 'bowl')) {
                battingTeam = isSecondInnings ? visitorTeam : hostTeam;
            } else {
                battingTeam = isSecondInnings ? hostTeam : visitorTeam;
            }
            
            document.getElementById('battingTeamName').innerText = battingTeam;
            
            const runs = inningsData.totalRuns;
            const wickets = inningsData.wickets;
            const balls = inningsData.ballsBowled;
            const overs = Math.floor(balls / 6);
            const ballsInOver = balls % 6;
            
            document.getElementById('score').innerText = `${runs}/${wickets}`;
            document.getElementById('overs').innerText = `(${overs}.${ballsInOver} Overs)`;
            
            // બેટ્સમેન અને બોલરની વિગતો (જો ડેટા હાજર હોય તો જ)
            if (inningsData.batsmen && inningsData.batsmen.length > inningsData.strikerIndex) {
                const striker = inningsData.batsmen[inningsData.strikerIndex];
                document.getElementById('strikerName').innerText = striker.name;
                document.getElementById('strikerScore').innerText = `${striker.runs} (${striker.balls})`;
            }
            if (inningsData.batsmen && inningsData.batsmen.length > inningsData.nonStrikerIndex) {
                 const nonStriker = inningsData.batsmen[inningsData.nonStrikerIndex];
                document.getElementById('nonStrikerName').innerText = nonStriker.name;
                document.getElementById('nonStrikerScore').innerText = `${nonStriker.runs} (${nonStriker.balls})`;
            }
            if (inningsData.bowlingCard && inningsData.bowlingCard.length > inningsData.currentBowlerIndex) {
                const bowler = inningsData.bowlingCard[inningsData.currentBowlerIndex];
                document.getElementById('bowlerName').innerText = bowler.name;
            }
        }
    </script>
</body>
</html>
